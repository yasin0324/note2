# 网络模型

---

![image2](C:\Users\锅\Desktop\guo\八股\image\image2.png)

## TCP/IP四层模型

+ 网络接口层

  + 网络接口层包括用于协作ip数据在已有网络介质上传输的协议。它定义像地址解析协议这样的协议，提供TCP/IP协议的数据结构和实际物理硬件之间的接口

  + 可以理解为：确定网络数据包的形式

+ 网络层

  + 网络层对应于OSI七层参考模型的网络层，本层包含IP协议、RIP协议，负责数据的包装、寻址和路由。同时还包含网间控制报文协议用来提供网络诊断信息

  + 可以理解为：该层能确定计算机的位置

+ 传输层

  + 传输层对应于OSI七层参考模型的传输层，它提供两种端到端的通信服务。其中TCP协议提供可靠的数据流运输服务，UDP协议提供不可靠的用户数据报服务

  + TCP：三次握手、四次挥手（面向连接， 可靠）

  + UDP：面向无连接

+ 应用层
  + 应用层对应于OSI七层参考模型的应用层和表达层、会话层

## OSI七层参考模型（Open System Interconnection：开放系统互连）

由低到高有七层：物理层、数据链路层、网络层、传输层、表示层、会话层、应用层

+ 应用层：
  + 专门用于应用程序。与其他计算机进行通讯的一个应用，解决最终通信双方数据传输问题，即不同节点上两个对应应用之间的通信
  + 协议有HTTP、FTP、TFTP、SMTP、SNMP、DNS、TELNET、HTTP、POP3、DHCP等
+ 表示层：
  + 定义数据格式以及加密
  + 在五层模型里面已经合并到了应用层
  + 格式有JPEG、ASCII、DECOIC、加密格式等
+ 会话层：
  + 在会话层及以上的高层次中，数据传送的单位不再另外命名，统称为报文。会话层不参与具体的传输，它提供包括访问验证和会话管理在内的建立和维护应用之间通信的机制。如服务器验证用户登录便是由会话层完成的。定义了如何开始、控制和终止一个会话
  + 在五层模型里面已经合并到了应用层
  + 对应主机进程，指本地主机与远程主机正在进行的会话
+ 传输层：
  + 提供端对端的通信管理。定义传输数据的协议端口号，以及流控和差错检验
  + 协议有：TCP、UDP等，数据包一旦离开网卡即进入网络传输层
+ 网络层：
  + 进行逻辑地址寻址，实现不同网络之间的路径选择
  + （路由选择）协议有：ICMP、IGMP、IP（IPV4、IPV6）、ARP、RARP
  + 在计算机网络中进行通信的两个计算机之间可能会经过很多个数据链路，也可能还要经过很多通信子网。网络层的任务就是选择合适的网间路由和交换结点，确保数据及时传送。网络层将数据链路层提供的帧组成数据包，包中封装有网络层包头，其中含有逻辑地址信息-源站点和目的站点地址的网络地址
+ 数据链路层：
  + 采取差错检测、差错控制、流量控制等方法将有差错的物理线路变为无差错的数据链路
  + 传输介质为“帧”
+ 物理层：
  + 作用是建立、维护、断开物理连接。
  + 物理层实际上就是布线、光纤、网卡和其他用来把两台网络通信设备连接在一起的东西
  + 物理层设置目的就是屏蔽通信设备和通信技术，只需要考虑如何使用物理层服务
  + 传输介质为“比特”

# 浏览器输入url会发生什么

---

> **大致的执行顺序：**URL解析 -> DNS解析：缓存判断+查询IP地址 -> TCP连接：TCP三次握手 -> SSL/TLS四次握手（https才有） -> 浏览器发送请求 -> 浏览器响应请求并返回数据 -> 浏览器解析渲染页面 -> 断开连接：TCP四次挥手

1. **解析url：**首先会对url进行解析，分析所需要使用的传输协议和请求的资源的路径。如果输入的字符不是一个合法的url结构，浏览器会使用搜索引擎对这个字符串进行搜索。如果没有问题，浏览器会检查url中是否出现了非法字符，如果存在非法字符，则会对非法字符进行转义后再进行下一过程。
2. **缓存判断：**浏览器会判断所请求的资源是否在缓存里，如果请求的资源在缓存里，如果请求的资源在缓存里并且没有失效，那么就直接使用，否则向服务器发起新的请求。
3. **dns解析：**下一步首先需要获取的是输入的url中的域名的ip地址，首先会判断本地是否有该域名的ip地址的缓存，如果有则使用，如果没有则向本地dns服务器发起请求。本地dns服务器也会先检查是否存在缓存，如果没有就会先向根域名服务器发起请求，获得负责的顶级域名服务器的地址后，再向顶级域名服务器请求，然后获得负责的权威域名服务器的地址后，再向权威域名服务器发起请求，最终获得域名的ip地址后，本地dns服务器再将这个ip地址返回给请求的用户。用户向本地dns服务器发起请求属于递归请求，本地dns服务器向各级域名发起请求输入迭代请求。
4. **获取mac地址：**当浏览器得到ip地址后，数据传输还需要知道目的主机mac地址，因为应用层下发数据给传输层，tcp协议会指定源端口号和目的端口号，然后下发给网络层。网络层会将本机地址作为源地址，获取的ip地址作为目的地址。然后下发数据给数据链路层，数据链路层的发送需要加入通信双方的mac地址，本机的mac地址作为源mac地址，目的mac地址需要分情况处理。通过将ip地址与本机的子网掩码相与，可以判断是否与请求主机在同一个子网里，如果在同一个子网里，可以使用apr协议获取到目的主机的mac地址，如果不在一个子网里，那么请求应该转发给网关，由它代为转发，此时同样可以通过arp协议来获取网关的mac地址，此时目的主机的mac地址应该为网关的地址。
5. **tcp三次握手：**下面是tcp建立连接的三次握手过程，首先客户端向服务器发送一个syn连接请求报文段和一个随机序号，服务端接受到请求后向服务器端发送一个syn ack报文段，确认连接请求，并且也向客户端发送一个随机序号。客户端接收服务器的确认应答后，进入连接建立的状态，同时向服务器也发送一个ack确认报文段，服务器端接受到确认后，也进入连接建立状态，此时双方的连接就建立起来了。
6. **https握手：**如果使用的是https协议，在通信前还存在tls的一个四次握手的过程。首先由客户端向服务器端发送使用的协议的版本号、一个随机数和可以使用的加密方法。服务器端收到后，确认加密的方法，也向客户端发送一个随机数和自己的数字证书。客户端收到后，首先检查数字证书是否有效，如果有效，则再生成一个随机数，并使用证书中的公钥对随机数加密，然后发送给服务器端，并且还会提供一个前面所有内容的hash值供服务器端校验。服务器端接收后，使用自己的私钥对数据解密，同时向客户端发送一个前面所有内容的hash值供客户端校验。这个时候双方都有了三个随机数，按照之前所约定的加密方法，使用这三个随机数生成一把密钥，以后双方通信前，就是用这个密钥对数据进行加密后再传输。
7. **返回数据：**当页面请求发送到服务器端后，服务器端会返回一个html文件作文响应，浏览器接受到响应后，开始对html文件进行解析，开始页面的渲染过程。
8. **页面渲染：**浏览器首先会根据html文件构建DOM树，根据解析到的css文件构建CSSOM树，如果遇到script标签，则判断是否含有defer或者async属性，要不然script的加载和执行会造成页面的渲染的阻塞。当DOM树和CSSOM树建立好后，根据它们来构建渲染树。渲染树构建好后，会根据渲染树来进行布局。布局完成后，最后使用浏览器的UI接口对页面进行绘制。这个时候整个页面就显示出来了。
9. **tcp四次挥手：**最后一步是tcp断开连接的四次挥手过程。若客户端认为数据发送完成，则它需要向服务器发送连接释放请求。服务端收到连接释放请求后，会告诉应用层要释放tcp连接。然后会发送ack包，并进入CLOSE_WAIT状态，此时表明客户端到服务端的连接已经释放，不再接收客户端发的数据了。但是因为tcp连接时双向的，所以服务端仍旧可以发送数据给客户端。服务端如果此时还有没发完的数据会继续发送，完毕后会向客户端发送连接释放请求，然后服务端便进入LAST-ACK状态。客户端收到释放请求后，想服务端发送确认应答，此时客户端进入TIME-WAIT状态。该状态会持续2MSL（最大段生存期，指报文段在网络中生存的事件，超时会被抛弃）时间，若该时间段内没有服务端的重发请求的话，就进入CLOSED状态。当服务端收到确认应答后，也便进入CLOSED状态。

